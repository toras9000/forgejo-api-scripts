#!/usr/bin/env -S dotnet run --file
#:package ForgejoApiClient@13.0.0-rev.1
#:package Kokuban@0.2.0
#:package Lestaly.General@0.114.0
#:package RefFile@0.2.0
#:property PublishAot=false
using ForgejoApiClient;
using ForgejoApiClient.Api;
using Kokuban;
using Lestaly;

[assembly: RefFile("../.env-helper.cs1")]

var settings = new
{
    // サービスURL
    ServiceURL = new Uri("http://localhost:9940/"),

    // トークン保存ファイル
    AdminApiKeyFile = ThisSource.RelativeFile("../.admin-forgejo.key"),

    // クォータ設定
    Quota = new
    {
        // クォータグループ名
        GroupName = "default-quota",

        // クォータルール
        Rules = new CreateQuotaRuleOptions[]
        {
            new(name: "default-git-limit",          limit:  8 * 1024 * 1024 * 1024L, subjects: ["size:git:all"]),
            new(name: "default-repos-limit",        limit:  8 * 1024 * 1024 * 1024L, subjects: ["size:repos:all"]),
            new(name: "default-artifacts-limit",    limit:  2 * 1024 * 1024 * 1024L, subjects: ["size:assets:artifacts"]),
            new(name: "default-attachments-limit",  limit:  2 * 1024 * 1024 * 1024L, subjects: ["size:assets:attachments:all"]),
            new(name: "default-packages-limit",     limit: 16 * 1024 * 1024 * 1024L, subjects: ["size:assets:packages:all"]),
        },
    },
};

return await Paved.ProceedAsync(noPause: args.RoughContains("--no-interact"), async () =>
{
    using var signal = new SignalCancellationPeriod();
    using var outenc = Console.OutputUtf8EncodingPeriod();

    Console.WriteLine("APIトークンを読み込み ...");
    var forgejoToken = await settings.AdminApiKeyFile.ScriptScrambler().LoadTokenAsync(signal.Token) ?? throw new Exception("トークン情報を読み取れない");
    if (forgejoToken.Service.AbsoluteUri != settings.ServiceURL.AbsoluteUri) throw new Exception("保存情報が対象と合わない");

    Console.WriteLine("クライアント準備 ...");
    using var forgejo = new ForgejoClient(forgejoToken.Service, forgejoToken.Token);

    Console.WriteLine("クォータグループの存在チェック");
    try
    {
        await forgejo.Admin.GetQuotaGroupAsync(settings.Quota.GroupName, signal.Token);
        Console.WriteLine(".. 既に存在する");
        return;
    }
    catch { }

    Console.WriteLine("クォータグループの作成");
    var options = new CreateQuotaGroupOptions(name: settings.Quota.GroupName, rules: settings.Quota.Rules);
    await forgejo.Admin.CreateQuotaGroupAsync(options, signal.Token);

    Console.WriteLine(Chalk.Green[".. 完了"]);
});
