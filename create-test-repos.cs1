#!/usr/bin/env -S dotnet run --file
#:package ForgejoApiClient@14.0.0-rev.1
#:package R3@1.3.0
#:package Kokuban@0.2.0
#:package Lestaly.General@0.116.0
#:package RefFile@0.2.0
#:property PublishAot=false
using ForgejoApiClient;
using ForgejoApiClient.Api;
using Kokuban;
using Lestaly;

[assembly: RefFile(".env-helper.cs1")]

// 設定
var settings = new
{
    // Forgejo 関連の情報
    Forgejo = new
    {
        // サービスURL
        ServiceURL = new Uri("http://localhost:9940/"),

        // APIキー保存ファイル
        ApiTokenFile = ThisSource.RelativeFile(".toras-forgejo.key"),
    },

    // テストリポジトリ
    TestRepos = new[]
    {
        ThisSource.RelativeDirectory("./test-repos/show-vars"),
        ThisSource.RelativeDirectory("./test-repos/schedule"),
    },
};

// メイン処理
return await Paved.ProceedAsync(async () =>
{
    // コンソール準備
    using var signal = new SignalCancellationPeriod();
    using var outenc = Console.OutputUtf8EncodingPeriod();

    Console.WriteLine("テストリポジトを登録する");
    Console.WriteLine($"  Forgejo   : {settings.Forgejo.ServiceURL}");
    Console.WriteLine();

    Console.WriteLine("サービス認証情報の準備");
    var forgejoToken = await settings.Forgejo.ApiTokenFile.BindTokenAsync("Forgejo APIトークン", settings.Forgejo.ServiceURL, signal.Token);

    Console.WriteLine("Forgejo クライアントの生成 ...");
    using var forgejo = new ForgejoClient(forgejoToken.Service, forgejoToken.Token);
    var apiUser = await forgejo.User.GetMeAsync(cancelToken: signal.Token);
    if (apiUser.login == null) throw new PavedMessageException("情報取得失敗", PavedMessageKind.Error);
    Console.WriteLine(Chalk.Gray[$"  .. User: {apiUser.login}"]);
    Console.WriteLine();

    Console.WriteLine("リポジトリ作成 ...");
    foreach (var repoDir in settings.TestRepos)
    {
        var repoPath = $"{apiUser.login}/{repoDir.Name}";
        Console.WriteLine($"  {repoPath}");
        var repos = await forgejo.Repository.SearchAsync(q: repoPath, cancelToken: signal.Token);
        if (repos.data?.Any(r => r.full_name == repoPath) == true)
        {
            Console.WriteLine(Chalk.Gray[$"  .. 既に存在する"]);
            continue;
        }
        var repo = await forgejo.Repository.CreateAsync(new(name: repoDir.Name), cancelToken: signal.Token);
        Console.WriteLine(Chalk.Green["  .. 完了"]);

        Console.WriteLine("  .. ファイルの登録");
        var files = new List<ChangeFileOperation>();
        foreach (var file in repoDir.EnumerateFiles("*", SearchOption.AllDirectories))
        {
            var relPath = file.RelativePathFrom(repoDir, ignoreCase: true).Replace('\\', '/');
            var content = Convert.ToBase64String(file.ReadAllBytes());
            files.Add(new(ChangeFileOperationOperation.Create, path: relPath, content));
        }
        await forgejo.Repository.UpdateFilesAsync(apiUser.login, repoDir.Name, new(message: repoDir.Name, files: files), cancelToken: signal.Token);
        Console.WriteLine(Chalk.Green["  .. 完了"]);

        Console.WriteLine("  .. ブランチを作成 ...");
        await forgejo.Repository.CreateBranchAsync(apiUser.login, repoDir.Name, new(new_branch_name: "v0.0.0"), cancelToken: signal.Token);
        Console.WriteLine(Chalk.Green["  .. 完了"]);
    }

});
